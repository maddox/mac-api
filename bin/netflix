#!/bin/sh

osascript <<EOD

if application "Google Chrome" is running then
  tell application "Google Chrome"
    repeat with t in tabs of windows
      tell t
        if URL starts with "https://www.netflix.com/watch" then
          if ("$1" = "get") then

            set netflix to execute javascript "
              var mac_api = {};
              mac_api.title = (document.querySelector('.ellipsize-text'))? (document.querySelector('.ellipsize-text').childNodes[1])? document.querySelector('.ellipsize-text').childNodes[0].innerText:document.querySelector('.ellipsize-text').innerText:'paused for too long';
              mac_api.episode = (document.querySelector('.ellipsize-text') && document.querySelector('.ellipsize-text').childNodes[1])? document.querySelector('.ellipsize-text').childNodes[1].innerText+' - '+document.querySelector('.ellipsize-text').childNodes[2].innerText:'';
              mac_api.muted = document.querySelector('video').muted;
              mac_api.paused = document.querySelector('video').paused;
              mac_api.ended = document.querySelector('video').ended;
              mac_api.duration = document.querySelector('video').duration;
              mac_api.currentTime = document.querySelector('video').currentTime;
              JSON.stringify(mac_api);
            "
            return netflix

          else if ("$1" = "playpause") then
            execute javascript "
             var v = document.querySelector('video');
             if (v.paused) {
              v.play();
             }
             else {
              v.pause();
             }
            "
          else if ("$1" = "play") then
            execute javascript "document.querySelector('video').play()"
          else if ("$1" = "pause") then
            execute javascript "document.querySelector('video').pause()"

          #Note:
          #backward and forward commands under chrome need a hack to be executed
          #this will force the focus on the netflix tab
          else if ("$1" = "forward") then
            set query to "
              var videoPlayer = netflix.appContext.state.playerApp.getAPI().videoPlayer;
              var playerSessionId = videoPlayer.getAllPlayerSessionIds()[0];
              var player = videoPlayer.getVideoPlayerBySessionId(playerSessionId);
              player.seek(player.getCurrentTime()-10000);
            " as text
            set URL to "javascript:" & query
          else if ("$1" = "backward") then
            set query to "
              var videoPlayer = netflix.appContext.state.playerApp.getAPI().videoPlayer;
              var playerSessionId = videoPlayer.getAllPlayerSessionIds()[0];
              var player = videoPlayer.getVideoPlayerBySessionId(playerSessionId);
              player.seek(player.getCurrentTime()+30000);
            " as text
            set URL to "javascript:" & query
          end if
        end if
      end tell
    end repeat
  end tell
end if

if application "Safari" is running then
  tell application "Safari"
    repeat with t in tabs of windows
      tell t
        if URL starts with "https://www.netflix.com/watch" then
          if ("$1" = "get") then
            set netflix to do Javascript "
              var mac_api = {};
              mac_api.title = (document.querySelector('.ellipsize-text'))? (document.querySelector('.ellipsize-text').childNodes[1])? document.querySelector('.ellipsize-text').childNodes[0].innerText:document.querySelector('.ellipsize-text').innerText:'paused for too long';
              mac_api.episode = (document.querySelector('.ellipsize-text') && document.querySelector('.ellipsize-text').childNodes[1])? document.querySelector('.ellipsize-text').childNodes[1].innerText+' - '+document.querySelector('.ellipsize-text').childNodes[2].innerText:'';
              mac_api.muted = document.querySelector('video').muted;
              mac_api.paused = document.querySelector('video').paused;
              mac_api.ended = document.querySelector('video').ended;
              mac_api.duration = document.querySelector('video').duration;
              mac_api.currentTime = document.querySelector('video').currentTime;
              JSON.stringify(mac_api);
            "
            return netflix
          else if ("$1" = "playpause") then
            do JavaScript "
              var v = document.querySelector('video');
              if (v.paused) {
                v.play();
              }
              else {
                v.pause();
              }
            "
          else if ("$1" = "play") then
            do JavaScript "document.querySelector('video').play()"
          else if ("$1" = "pause") then
            do JavaScript "document.querySelector('video').pause()"
          else if ("$1" = "forward") then
            do JavaScript "
              var videoPlayer = netflix.appContext.state.playerApp.getAPI().videoPlayer
              var playerSessionId = videoPlayer.getAllPlayerSessionIds()[0]
              var player = videoPlayer.getVideoPlayerBySessionId(playerSessionId)
              player.seek(player.getCurrentTime()-10000);
            "
          else if ("$1" = "backward") then
            do JavaScript "
              var videoPlayer = netflix.appContext.state.playerApp.getAPI().videoPlayer;
              var playerSessionId = videoPlayer.getAllPlayerSessionIds()[0];
              var player = videoPlayer.getVideoPlayerBySessionId(playerSessionId);
              player.seek(player.getCurrentTime()+30000);
            "
          end if
        end if
      end tell
    end repeat
  end tell
end if

EOD
